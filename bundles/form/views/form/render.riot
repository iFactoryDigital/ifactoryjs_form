<form-render>
  <form ref="form" if={ props.action } method={ props.method || 'post' } action={ props.action || getForm().action || '/form/submit' } class={ `form-render form-${props.placement.split('.').join('-')}` }>
    <slot name="prepend" />
    
    <div class="form-render-fields" data-form={ props.placement } ref={ ref('fields') } is="eden-fields" fields={ getFields() } preview={ props.preview } form={ getForm() } on-save={ onSave } id={ props.placement } positions={ props.positions } />
    
    <slot name="append" />
  </form>
  <div if={ !props.action } class="form-render-fields" data-form={ props.placement } ref="fields" data-is="eden-fields" fields={ getFields() } preview={ props.preview } form={ getForm() } on-save={ onSave } id={ props.placement } positions={ props.positions } />

  <script>
    // import base
    import Base from '../js/base';

    // export default
    export default class FormRender extends Base {

      /**
       * on before mount
       */
      onBeforeMount() {
        // super
        super.onBeforeMount(...arguments);

        // is update
        this.isUpdate = false;
      }

      /**
       * on save forms
       *
       * @return {Model}
       */
      onSave (form) {
        // get forms
        let forms = this.eden.get('forms') || {};

        // set form
        forms[this.props.placement] = form.get();

        // set forms
        this.eden.set('forms', forms);
      }

      /**
       * on update name
       *
       * @param  {Event} e
       */
      onToggleUpdate (e) {
        // prevent default
        e.preventDefault();
        e.stopPropagation();

        // set update
        this.isUpdate = !this.isUpdate;

        // update
        this.update();
      }

      /**
       * add load fields function
       *
       * @return {*}
       */
      loadFields () {
        // return internal proxied
        return this.refs.fields.loadFields(...arguments);
      }

      /**
       * gets fields
       *
       * @return {Array}
       */
      getFields () {
        // check for fields
        return this.eden.get('fields') || [];
      }

      /**
       * returns form
       *
       * @return {Object}
       */
      getForm () {
        // return form
        return this.props.form || ((this.eden.get('forms') || {})[opts.placement] ? this.eden.get('forms')[opts.placement] : {
          'placement' : this.props.placement
        });
      }
      
      /**
       * submit form
       *
       * @return {*}
       */
      async submit (isJSON) {
        // check json
        if (!isJSON) {
          // submit form
          return jQuery(this.$('[ref="form"]')).submit();
        } else {
          // Get url
          let url = this.$('[ref="form"]').getAttribute('action') || window.location.href.split(this.eden.get('config').domain)[1];

          // Set request
          const opts = {
            method  : this.$('[ref="form"]').getAttribute('method') || 'POST',
            headers : {
              Accept : 'application/json',
            },
            redirect    : 'follow',
            credentials : 'same-origin',
          };

          // Set body
          if (this.props.method.toUpperCase() === 'POST') {
            // Set to body
            opts.body = new FormData(this.$('[ref="form"]'));
          } else {
            // Add to url
            url += `?${jQuery(this.$('[ref="form"]')).serialize()}`;
          }

          // Run fetch
          const res = await fetch(url, opts);

          // Run json
          return await res.json();
        }
      }
    }
  </script>
</form-render>
